import React, { useState } from 'react';

export default function MidwestRestorationApp() {
    const [currentUser, setCurrentUser] = useState(null);
    const [currentView, setCurrentView] = useState('dashboard');
    const [users] = useState([
        { id: 1, username: 'admin', password: 'admin123', name: 'Admin User', role: 'office' },
        { id: 2, username: 'john', password: 'tech123', name: 'John Doe', role: 'field' },
        { id: 3, username: 'jane', password: 'tech123', name: 'Jane Smith', role: 'field' },
        { id: 4, username: 'mike', password: 'tech123', name: 'Mike Johnson', role: 'field' }
    ]);
    
    const [jobs, setJobs] = useState([
        {
            id: 1,
            jobNumber: 'JOB-2024-001',
            claimNumber: 'CLM-2024-5678',
            insuranceCompany: 'State Farm',
            client: 'Smith Residence',
            address: '123 Main St, Springfield',
            type: 'water',
            status: 'in-progress',
            startDate: '2024-12-20',
            assignedTech: 'John Doe',
            priority: 'high',
            notes: 'Kitchen flood from dishwasher leak',
            moistureReadings: [
                { location: 'Kitchen Floor', reading: 45, date: '2024-12-20', tech: 'John Doe' },
                { location: 'Kitchen Floor', reading: 32, date: '2024-12-21', tech: 'John Doe' },
                { location: 'Kitchen Floor', reading: 18, date: '2024-12-22', tech: 'John Doe' }
            ],
            photos: [],
            equipment: [],
            documents: [],
            timeEntries: []
        }
    ]);
    
    const [selectedJob, setSelectedJob] = useState(jobs[0]);
    const [timeEntries, setTimeEntries] = useState([]);

    const addTimeEntry = (entry) => {
        setTimeEntries([...timeEntries, entry]);
    };

    const getWeeklyHours = () => {
        const now = new Date();
        const weekStart = new Date(now);
        weekStart.setDate(now.getDate() - now.getDay()); // Start of week (Sunday)
        weekStart.setHours(0, 0, 0, 0);

        const weeklyEntries = timeEntries.filter(entry => new Date(entry.clockIn) >= weekStart);
        
        const totalMinutes = weeklyEntries.reduce((total, entry) => {
            return total + entry.duration;
        }, 0);

        return (totalMinutes / 60).toFixed(1);
    };

    const jobTypes = {
        water: { color: 'bg-blue-500', label: 'Water' },
        fire: { color: 'bg-red-500', label: 'Fire' },
        mold: { color: 'bg-green-500', label: 'Mold' },
        contents: { color: 'bg-purple-500', label: 'Contents' }
    };

    const addJob = (newJob) => {
        const job = { 
            ...newJob, 
            id: Math.max(...jobs.map(j => j.id)) + 1, 
            moistureReadings: [], 
            photos: [], 
            equipment: [],
            timeEntries: [] 
        };
        setJobs([...jobs, job]);
    };

    const updateJob = (jobId, updates) => {
        setJobs(jobs.map(job => job.id === jobId ? { ...job, ...updates } : job));
        if (selectedJob?.id === jobId) {
            setSelectedJob({ ...selectedJob, ...updates });
        }
    };

    const addMoistureReading = (jobId, reading) => {
        const job = jobs.find(j => j.id === jobId);
        const updatedReadings = [...job.moistureReadings, { ...reading, tech: currentUser.name }];
        updateJob(jobId, { moistureReadings: updatedReadings });
    };

    const addPhoto = (jobId, photo) => {
        const job = jobs.find(j => j.id === jobId);
        const updatedPhotos = [...job.photos, { ...photo, timestamp: new Date().toLocaleString() }];
        updateJob(jobId, { photos: updatedPhotos });
    };

    const addEquipment = (jobId, equipment) => {
        const job = jobs.find(j => j.id === jobId);
        const updatedEquipment = [...job.equipment, { 
            ...equipment, 
            dateDeployed: new Date().toLocaleDateString(),
            status: 'active' 
        }];
        updateJob(jobId, { equipment: updatedEquipment });
    };

    const addDocument = (jobId, document) => {
        const job = jobs.find(j => j.id === jobId);
        const updatedDocuments = [...(job.documents || []), document];
        updateJob(jobId, { documents: updatedDocuments });
    };

    if (!currentUser) {
        return <LoginScreen users={users} setCurrentUser={setCurrentUser} />;
    }

    return (
        <div className="min-h-screen bg-gray-50">
            <header className="bg-gradient-to-r from-blue-600 to-blue-700 text-white shadow-lg">
                <div className="container mx-auto px-4 py-4">
                    <div className="flex justify-between items-center">
                        <div className="flex items-center space-x-3">
                            <div className="text-3xl">üíß</div>
                            <div>
                                <h1 className="text-2xl font-bold">Midwest Restoration Pros</h1>
                                <p className="text-sm text-blue-100">Professional Restoration Management</p>
                            </div>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="text-right">
                                <div className="text-sm font-medium">{currentUser.name}</div>
                                <div className="text-xs text-blue-200 capitalize">{currentUser.role}</div>
                            </div>
                            <button 
                                onClick={() => setCurrentUser(null)}
                                className="bg-blue-500 hover:bg-blue-600 px-4 py-2 rounded"
                            >
                                Logout
                            </button>
                        </div>
                    </div>
                </div>
            </header>

            <nav className="bg-white shadow-sm border-b">
                <div className="container mx-auto px-4">
                    <div className="flex space-x-1 overflow-x-auto">
                        <NavButton active={currentView === 'dashboard'} onClick={() => setCurrentView('dashboard')}>
                            üìä Dashboard
                        </NavButton>
                        <NavButton active={currentView === 'schedule'} onClick={() => setCurrentView('schedule')}>
                            üìÖ Schedule
                        </NavButton>
                        <NavButton active={currentView === 'jobs'} onClick={() => setCurrentView('jobs')}>
                            üìã Jobs
                        </NavButton>
                        <NavButton active={currentView === 'field-tools'} onClick={() => setCurrentView('field-tools')}>
                            üîß Field Tools
                        </NavButton>
                    </div>
                </div>
            </nav>

            <main className="container mx-auto px-4 py-6">
                {currentView === 'dashboard' && (
                    <Dashboard 
                        jobs={jobs} 
                        jobTypes={jobTypes} 
                        setCurrentView={setCurrentView} 
                        setSelectedJob={setSelectedJob}
                        weeklyHours={getWeeklyHours()}
                        currentUser={currentUser}
                    />
                )}
                {currentView === 'schedule' && (
                    <Schedule jobs={jobs} addJob={addJob} jobTypes={jobTypes} users={users} setSelectedJob={setSelectedJob} setCurrentView={setCurrentView} />
                )}
                {currentView === 'jobs' && (
                    <JobsList jobs={jobs} jobTypes={jobTypes} setSelectedJob={setSelectedJob} setCurrentView={setCurrentView} updateJob={updateJob} />
                )}
                {currentView === 'field-tools' && (
                    <FieldTools 
                        jobs={jobs} 
                        selectedJob={selectedJob}
                        setSelectedJob={setSelectedJob}
                        addMoistureReading={addMoistureReading}
                        addPhoto={addPhoto}
                        addEquipment={addEquipment}
                        addDocument={addDocument}
                        addTimeEntry={addTimeEntry}
                        currentUser={currentUser}
                    />
                )}
            </main>
        </div>
    );
}

function LoginScreen({ users, setCurrentUser }) {
    const [username, setUsername] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const handleLogin = (e) => {
        e.preventDefault();
        const user = users.find(u => u.username === username && u.password === password);
        if (user) {
            setCurrentUser(user);
            setError('');
        } else {
            setError('Invalid username or password');
        }
    };

    return (
        <div className="min-h-screen bg-gradient-to-br from-blue-500 to-blue-700 flex items-center justify-center p-4">
            <div className="bg-white rounded-lg shadow-xl p-8 max-w-md w-full">
                <div className="text-center mb-8">
                    <div className="text-6xl mb-4">üíß</div>
                    <h1 className="text-3xl font-bold text-gray-800">Midwest Restoration Pros</h1>
                    <p className="text-gray-600">Management System</p>
                </div>

                <form onSubmit={handleLogin} className="space-y-4">
                    <div>
                        <label className="block text-sm font-medium mb-2">Username</label>
                        <input 
                            type="text"
                            value={username}
                            onChange={(e) => setUsername(e.target.value)}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="Enter username"
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-2">Password</label>
                        <input 
                            type="password"
                            value={password}
                            onChange={(e) => setPassword(e.target.value)}
                            className="w-full px-4 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none"
                            placeholder="Enter password"
                        />
                    </div>

                    {error && (
                        <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded">
                            {error}
                        </div>
                    )}

                    <button 
                        type="submit"
                        className="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-lg"
                    >
                        Login
                    </button>
                </form>

                <div className="mt-6 p-4 bg-gray-50 rounded text-sm">
                    <p className="font-semibold mb-2">Demo Accounts:</p>
                    <p className="text-gray-600"><strong>Office:</strong> admin / admin123</p>
                    <p className="text-gray-600"><strong>Field:</strong> john, jane, mike / tech123</p>
                </div>
            </div>
        </div>
    );
}

function NavButton({ active, onClick, children }) {
    return (
        <button
            onClick={onClick}
            className={`px-4 py-3 text-sm font-medium transition-colors ${
                active
                    ? 'text-blue-600 border-b-2 border-blue-600'
                    : 'text-gray-600 hover:text-gray-900'
            }`}
        >
            {children}
        </button>
    );
}

function Dashboard({ jobs, jobTypes, setCurrentView, setSelectedJob, weeklyHours, currentUser }) {
    const activeJobs = jobs.filter(j => j.status !== 'completed');
    const completedJobs = jobs.filter(j => j.status === 'completed');

    return (
        <div className="space-y-6">
            <h2 className="text-2xl font-bold">Dashboard</h2>

            <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div className="bg-white p-6 rounded-lg shadow">
                    <div className="text-3xl font-bold text-blue-600">{activeJobs.length}</div>
                    <div className="text-gray-600">Active Jobs</div>
                </div>
                <div className="bg-white p-6 rounded-lg shadow">
                    <div className="text-3xl font-bold text-green-600">{completedJobs.length}</div>
                    <div className="text-gray-600">Completed Jobs</div>
                </div>
                <div className="bg-white p-6 rounded-lg shadow">
                    <div className="text-3xl font-bold text-purple-600">{jobs.length}</div>
                    <div className="text-gray-600">Total Jobs</div>
                </div>
                <div className="bg-white p-6 rounded-lg shadow">
                    <div className="text-3xl font-bold text-orange-600">{weeklyHours}</div>
                    <div className="text-gray-600">Hours This Week</div>
                </div>
            </div>

            <div className="bg-white rounded-lg shadow p-6">
                <h3 className="text-xl font-semibold mb-4">Recent Jobs</h3>
                <div className="space-y-3">
                    {jobs.slice(0, 5).map(job => (
                        <div 
                            key={job.id}
                            className="flex items-center justify-between p-3 border rounded-lg hover:bg-gray-50 cursor-pointer"
                            onClick={() => {
                                setSelectedJob(job);
                                setCurrentView('field-tools');
                            }}
                        >
                            <div className="flex items-center gap-3">
                                <div className={`w-3 h-3 rounded-full ${jobTypes[job.type].color}`}></div>
                                <div>
                                    <div className="font-medium">{job.client}</div>
                                    <div className="text-sm text-gray-500">{job.jobNumber}</div>
                                </div>
                            </div>
                            <div className="text-sm text-gray-600 capitalize">{job.status}</div>
                        </div>
                    ))}
                </div>
            </div>
        </div>
    );
}

function Schedule({ jobs, addJob, jobTypes, users, setSelectedJob, setCurrentView }) {
    const [currentDate, setCurrentDate] = useState(new Date());
    const [showNewJobModal, setShowNewJobModal] = useState(false);
    const [selectedDate, setSelectedDate] = useState('');

    const getDaysInMonth = (date) => {
        const year = date.getFullYear();
        const month = date.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDayOfWeek = firstDay.getDay();

        const days = [];
        for (let i = 0; i < startingDayOfWeek; i++) {
            days.push(null);
        }
        for (let i = 1; i <= daysInMonth; i++) {
            days.push(i);
        }
        return days;
    };

    const formatDateForJob = (day) => {
        const year = currentDate.getFullYear();
        const month = String(currentDate.getMonth() + 1).padStart(2, '0');
        const dayStr = String(day).padStart(2, '0');
        return `${year}-${month}-${dayStr}`;
    };

    const getJobsForDay = (day) => {
        if (!day) return [];
        const dateStr = formatDateForJob(day);
        return jobs.filter(job => job.startDate === dateStr);
    };

    const handleDayClick = (day) => {
        if (!day) return;
        setSelectedDate(formatDateForJob(day));
        setShowNewJobModal(true);
    };

    const days = getDaysInMonth(currentDate);

    return (
        <div className="space-y-6">
            <div className="flex justify-between items-center">
                <h2 className="text-2xl font-bold">Schedule</h2>
                <div className="flex gap-2">
                    <button
                        onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() - 1)))}
                        className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
                    >
                        ‚Üê Previous
                    </button>
                    <button
                        onClick={() => setCurrentDate(new Date())}
                        className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                    >
                        Today
                    </button>
                    <button
                        onClick={() => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + 1)))}
                        className="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300"
                    >
                        Next ‚Üí
                    </button>
                </div>
            </div>

            <div className="bg-white rounded-lg shadow p-4">
                <h3 className="text-lg font-semibold mb-4">
                    {currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}
                </h3>

                <div className="grid grid-cols-7 gap-2">
                    {['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].map(day => (
                        <div key={day} className="text-center font-semibold text-gray-600 p-2">
                            {day}
                        </div>
                    ))}

                    {days.map((day, i) => {
                        const dayJobs = day ? getJobsForDay(day) : [];
                        return (
                            <div 
                                key={i} 
                                className={`bg-white p-2 min-h-24 border ${day ? 'hover:bg-gray-50 cursor-pointer' : 'bg-gray-100'}`}
                                onClick={() => day && dayJobs.length === 0 && handleDayClick(day)}
                            >
                                {day && (
                                    <>
                                        <div className="font-semibold text-sm mb-1">{day}</div>
                                        <div className="space-y-1">
                                            {dayJobs.map(job => (
                                                <div 
                                                    key={job.id}
                                                    onClick={(e) => {
                                                        e.stopPropagation();
                                                        setSelectedJob(job);
                                                        setCurrentView('field-tools');
                                                    }}
                                                    className={`${jobTypes[job.type].color} text-white text-xs p-1 rounded cursor-pointer hover:opacity-80`}
                                                >
                                                    <div className="font-medium truncate">{job.client}</div>
                                                </div>
                                            ))}
                                            {dayJobs.length === 0 && (
                                                <div className="text-xs text-gray-400 text-center">+ Add Job</div>
                                            )}
                                        </div>
                                    </>
                                )}
                            </div>
                        );
                    })}
                </div>
            </div>

            {showNewJobModal && (
                <NewJobModal 
                    selectedDate={selectedDate}
                    onClose={() => setShowNewJobModal(false)}
                    jobTypes={jobTypes}
                    users={users}
                    addJob={addJob}
                />
            )}
        </div>
    );
}

function NewJobModal({ selectedDate, onClose, jobTypes, users, addJob }) {
    const [formData, setFormData] = useState({
        jobNumber: '',
        claimNumber: '',
        insuranceCompany: '',
        client: '',
        address: '',
        type: 'water',
        assignedTech: '',
        priority: 'medium',
        notes: '',
        startDate: selectedDate,
        status: 'scheduled'
    });

    const fieldTechs = users.filter(u => u.role === 'field');

    const handleSubmit = () => {
        if (!formData.jobNumber || !formData.client || !formData.address || !formData.assignedTech) {
            alert('Please fill in all required fields');
            return;
        }
        addJob(formData);
        alert('Job created successfully!');
        onClose();
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6 max-h-[90vh] overflow-y-auto">
                <h3 className="text-xl font-semibold mb-4">Create New Job for {selectedDate}</h3>

                <div className="space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium mb-2">Job Number *</label>
                            <input 
                                type="text"
                                value={formData.jobNumber}
                                onChange={(e) => setFormData({...formData, jobNumber: e.target.value})}
                                className="w-full px-4 py-2 border rounded-lg"
                                placeholder="JOB-2024-001"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-2">Job Type *</label>
                            <select 
                                value={formData.type}
                                onChange={(e) => setFormData({...formData, type: e.target.value})}
                                className="w-full px-4 py-2 border rounded-lg"
                            >
                                {Object.entries(jobTypes).map(([key, type]) => (
                                    <option key={key} value={key}>{type.label}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium mb-2">Claim Number</label>
                            <input 
                                type="text"
                                value={formData.claimNumber}
                                onChange={(e) => setFormData({...formData, claimNumber: e.target.value})}
                                className="w-full px-4 py-2 border rounded-lg"
                                placeholder="CLM-2024-1234"
                            />
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-2">Insurance Company</label>
                            <input 
                                type="text"
                                value={formData.insuranceCompany}
                                onChange={(e) => setFormData({...formData, insuranceCompany: e.target.value})}
                                className="w-full px-4 py-2 border rounded-lg"
                                placeholder="State Farm, Allstate"
                            />
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-2">Client Name *</label>
                        <input 
                            type="text"
                            value={formData.client}
                            onChange={(e) => setFormData({...formData, client: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg"
                            placeholder="Smith Residence"
                        />
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-2">Address *</label>
                        <input 
                            type="text"
                            value={formData.address}
                            onChange={(e) => setFormData({...formData, address: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg"
                            placeholder="123 Main St, Springfield"
                        />
                    </div>

                    <div className="grid grid-cols-2 gap-4">
                        <div>
                            <label className="block text-sm font-medium mb-2">Assigned Tech *</label>
                            <select 
                                value={formData.assignedTech}
                                onChange={(e) => setFormData({...formData, assignedTech: e.target.value})}
                                className="w-full px-4 py-2 border rounded-lg"
                            >
                                <option value="">Select tech...</option>
                                {fieldTechs.map(tech => (
                                    <option key={tech.id} value={tech.name}>{tech.name}</option>
                                ))}
                            </select>
                        </div>
                        <div>
                            <label className="block text-sm font-medium mb-2">Priority</label>
                            <select 
                                value={formData.priority}
                                onChange={(e) => setFormData({...formData, priority: e.target.value})}
                                className="w-full px-4 py-2 border rounded-lg"
                            >
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label className="block text-sm font-medium mb-2">Notes</label>
                        <textarea 
                            value={formData.notes}
                            onChange={(e) => setFormData({...formData, notes: e.target.value})}
                            className="w-full px-4 py-2 border rounded-lg"
                            rows="3"
                            placeholder="Additional details..."
                        />
                    </div>
                </div>

                <div className="flex gap-3 mt-6">
                    <button 
                        onClick={onClose}
                        className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-6 py-2 rounded-lg"
                    >
                        Cancel
                    </button>
                    <button 
                        onClick={handleSubmit}
                        className="flex-1 bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg"
                    >
                        Create Job
                    </button>
                </div>
            </div>
        </div>
    );
}

function JobsList({ jobs, jobTypes, setSelectedJob, setCurrentView, updateJob }) {
    return (
        <div className="space-y-6">
            <h2 className="text-2xl font-bold">All Jobs</h2>

            <div className="space-y-4">
                {jobs.map(job => (
                    <div key={job.id} className="bg-white rounded-lg shadow p-4">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className={`w-4 h-4 rounded-full ${jobTypes[job.type].color}`}></div>
                                <div>
                                    <div className="font-semibold">{job.client}</div>
                                    <div className="text-sm text-gray-600">{job.jobNumber}</div>
                                    {job.claimNumber && (
                                        <div className="text-sm text-blue-600">Claim: {job.claimNumber}</div>
                                    )}
                                </div>
                            </div>
                            <div className="flex items-center gap-3">
                                <div className="text-sm text-gray-600">üë§ {job.assignedTech}</div>
                                <button
                                    onClick={() => {
                                        setSelectedJob(job);
                                        setCurrentView('field-tools');
                                    }}
                                    className="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700"
                                >
                                    View Details
                                </button>
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}

function FieldTools({ jobs, selectedJob, setSelectedJob, addMoistureReading, addPhoto, addEquipment, addDocument, addTimeEntry, currentUser }) {
    const [activeTab, setActiveTab] = useState('moisture');
    const [isClockedIn, setIsClockedIn] = useState(false);
    const [clockInTime, setClockInTime] = useState(null);
    const [newReading, setNewReading] = useState({ location: '', reading: '', date: new Date().toISOString().split('T')[0] });
    const [newPhoto, setNewPhoto] = useState({ notes: '', imageData: null });
    const [newEquipment, setNewEquipment] = useState({ name: '', quantity: 1 });
    const [showSignatureModal, setShowSignatureModal] = useState(false);
    const [selectedDocForSigning, setSelectedDocForSigning] = useState(null);
    const [uploadedDoc, setUploadedDoc] = useState(null);

    if (!selectedJob) {
        return (
            <div className="bg-white rounded-lg shadow p-8 text-center">
                <p className="text-gray-500 mb-4">Please select a job to use field tools</p>
                <select 
                    onChange={(e) => setSelectedJob(jobs.find(j => j.id === parseInt(e.target.value)))}
                    className="px-4 py-2 border rounded-lg"
                >
                    <option value="">Select a job...</option>
                    {jobs.map(job => (
                        <option key={job.id} value={job.id}>{job.jobNumber} - {job.client}</option>
                    ))}
                </select>
            </div>
        );
    }

    const handleAddMoistureReading = () => {
        if (newReading.location && newReading.reading && newReading.date) {
            addMoistureReading(selectedJob.id, newReading);
            setNewReading({ location: '', reading: '', date: new Date().toISOString().split('T')[0] });
        }
    };

    const handlePhotoCapture = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
                setNewPhoto({ ...newPhoto, imageData: reader.result });
            };
            reader.readAsDataURL(file);
        }
    };

    const handleAddPhoto = () => {
        if (newPhoto.imageData) {
            addPhoto(selectedJob.id, newPhoto);
            setNewPhoto({ notes: '', imageData: null });
        }
    };

    const handleAddEquipment = () => {
        if (newEquipment.name) {
            addEquipment(selectedJob.id, newEquipment);
            setNewEquipment({ name: '', quantity: 1 });
        }
    };

    const handleDocumentUpload = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onloadend = () => {
                setUploadedDoc({
                    name: file.name,
                    type: file.type,
                    imageData: reader.result
                });
            };
            reader.readAsDataURL(file);
        }
    };

    const handleOpenSignature = () => {
        if (uploadedDoc) {
            setSelectedDocForSigning(uploadedDoc);
            setShowSignatureModal(true);
        }
    };

    const handleSaveSignedDocument = (signatureData, signerName) => {
        const signedDoc = {
            ...uploadedDoc,
            signatureData,
            signerName,
            signedDate: new Date().toLocaleString(),
            signedBy: currentUser.name
        };
        addDocument(selectedJob.id, signedDoc);
        setUploadedDoc(null);
        setShowSignatureModal(false);
        alert('Document signed and saved!');
    };

    const handleClockIn = () => {
        setClockInTime(new Date());
        setIsClockedIn(true);
    };

    const handleClockOut = () => {
        const clockOutTime = new Date();
        const duration = Math.floor((clockOutTime - clockInTime) / 60000); // minutes
        const hours = Math.floor(duration / 60);
        const minutes = duration % 60;
        
        // Save time entry
        addTimeEntry({
            techName: currentUser.name,
            jobNumber: selectedJob.jobNumber,
            clockIn: clockInTime.toISOString(),
            clockOut: clockOutTime.toISOString(),
            duration: duration
        });
        
        alert(`Clocked out! Time worked: ${hours}h ${minutes}m`);
        setIsClockedIn(false);
        setClockInTime(null);
    };

    return (
        <div className="space-y-6">
            <div className="bg-white rounded-lg shadow p-4">
                <div className="flex justify-between items-start mb-4">
                    <div>
                        <h3 className="font-bold text-lg mb-1">Current Job: {selectedJob.jobNumber}</h3>
                        <p className="text-gray-600">{selectedJob.client}</p>
                        <p className="text-sm text-gray-500">{selectedJob.address}</p>
                        {selectedJob.claimNumber && (
                            <p className="text-sm text-blue-600 mt-1">üìã Claim: {selectedJob.claimNumber}</p>
                        )}
                        {selectedJob.insuranceCompany && (
                            <p className="text-sm text-gray-500">üè¢ {selectedJob.insuranceCompany}</p>
                        )}
                    </div>
                    <a 
                        href={`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(selectedJob.address)}`}
                        target="_blank"
                        rel="noopener noreferrer"
                        className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg"
                    >
                        üó∫Ô∏è Navigate
                    </a>
                </div>

                <div className="flex gap-2">
                    {!isClockedIn ? (
                        <button 
                            onClick={handleClockIn}
                            className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg"
                        >
                            üïê Clock In
                        </button>
                    ) : (
                        <button 
                            onClick={handleClockOut}
                            className="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg"
                        >
                            üïê Clock Out
                        </button>
                    )}
                </div>
            </div>

            <div className="bg-white rounded-lg shadow">
                <div className="border-b flex">
                    <button
                        onClick={() => setActiveTab('moisture')}
                        className={`px-6 py-3 font-medium ${activeTab === 'moisture' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
                    >
                        üíß Moisture
                    </button>
                    <button
                        onClick={() => setActiveTab('photos')}
                        className={`px-6 py-3 font-medium ${activeTab === 'photos' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
                    >
                        üì∑ Photos
                    </button>
                    <button
                        onClick={() => setActiveTab('equipment')}
                        className={`px-6 py-3 font-medium ${activeTab === 'equipment' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
                    >
                        üîß Equipment
                    </button>
                    <button
                        onClick={() => setActiveTab('documents')}
                        className={`px-6 py-3 font-medium ${activeTab === 'documents' ? 'border-b-2 border-blue-600 text-blue-600' : 'text-gray-600'}`}
                    >
                        üìÑ Documents
                    </button>
                </div>

                <div className="p-6">
                    {activeTab === 'moisture' && (
                        <div className="space-y-6">
                            <div className="bg-gray-50 p-4 rounded-lg">
                                <h4 className="font-semibold mb-4">Add Moisture Reading</h4>
                                <div className="grid grid-cols-3 gap-4">
                                    <input 
                                        type="text"
                                        placeholder="Location (e.g., Kitchen Floor)"
                                        value={newReading.location}
                                        onChange={(e) => setNewReading({...newReading, location: e.target.value})}
                                        className="px-4 py-2 border rounded-lg"
                                    />
                                    <input 
                                        type="number"
                                        placeholder="Reading %"
                                        value={newReading.reading}
                                        onChange={(e) => setNewReading({...newReading, reading: e.target.value})}
                                        className="px-4 py-2 border rounded-lg"
                                    />
                                    <input 
                                        type="date"
                                        value={newReading.date}
                                        onChange={(e) => setNewReading({...newReading, date: e.target.value})}
                                        className="px-4 py-2 border rounded-lg"
                                    />
                                </div>
                                <button 
                                    onClick={handleAddMoistureReading}
                                    className="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
                                >
                                    Add Reading
                                </button>
                            </div>

                            <div>
                                <h4 className="font-semibold mb-4">Moisture Readings</h4>
                                {selectedJob.moistureReadings.length > 0 ? (
                                    <div className="space-y-3">
                                        {selectedJob.moistureReadings.map((reading, index) => (
                                            <div key={index} className="p-3 border rounded-lg">
                                                <div className="flex justify-between">
                                                    <div>
                                                        <div className="font-medium">{reading.location}</div>
                                                        <div className="text-sm text-gray-600">{reading.date}</div>
                                                    </div>
                                                    <div className="text-xl font-bold">{reading.reading}%</div>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-gray-500">No readings yet</p>
                                )}
                            </div>
                        </div>
                    )}

                    {activeTab === 'photos' && (
                        <div className="space-y-6">
                            <div className="bg-gray-50 p-4 rounded-lg">
                                <h4 className="font-semibold mb-4">Add Photo</h4>
                                <input 
                                    type="file"
                                    accept="image/*"
                                    onChange={handlePhotoCapture}
                                    className="block w-full mb-4"
                                />
                                {newPhoto.imageData && (
                                    <div>
                                        <img src={newPhoto.imageData} alt="Preview" className="max-w-full h-48 object-contain mb-2" />
                                        <textarea 
                                            placeholder="Add notes for this photo..."
                                            value={newPhoto.notes}
                                            onChange={(e) => setNewPhoto({...newPhoto, notes: e.target.value})}
                                            className="w-full px-4 py-2 border rounded-lg"
                                            rows="3"
                                        />
                                        <button 
                                            onClick={handleAddPhoto}
                                            className="mt-2 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
                                        >
                                            Save Photo
                                        </button>
                                    </div>
                                )}
                            </div>

                            <div>
                                <h4 className="font-semibold mb-4">Photo Gallery</h4>
                                {selectedJob.photos.length > 0 ? (
                                    <div className="grid grid-cols-2 gap-4">
                                        {selectedJob.photos.map((photo, index) => (
                                            <div key={index} className="border rounded-lg p-2">
                                                <img src={photo.imageData} alt={`Photo ${index + 1}`} className="w-full mb-2" />
                                                <p className="text-sm font-semibold">{photo.notes}</p>
                                                <p className="text-xs text-gray-500">{photo.timestamp}</p>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-gray-500">No photos yet</p>
                                )}
                            </div>
                        </div>
                    )}

                    {activeTab === 'equipment' && (
                        <div className="space-y-6">
                            <div className="bg-gray-50 p-4 rounded-lg">
                                <h4 className="font-semibold mb-4">Deploy Equipment</h4>
                                <div className="grid grid-cols-2 gap-4">
                                    <input 
                                        type="text"
                                        placeholder="Equipment name"
                                        value={newEquipment.name}
                                        onChange={(e) => setNewEquipment({...newEquipment, name: e.target.value})}
                                        className="px-4 py-2 border rounded-lg"
                                    />
                                    <input 
                                        type="number"
                                        placeholder="Quantity"
                                        value={newEquipment.quantity}
                                        onChange={(e) => setNewEquipment({...newEquipment, quantity: e.target.value})}
                                        className="px-4 py-2 border rounded-lg"
                                    />
                                </div>
                                <button 
                                    onClick={handleAddEquipment}
                                    className="mt-4 bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700"
                                >
                                    Deploy Equipment
                                </button>
                            </div>

                            <div>
                                <h4 className="font-semibold mb-4">Deployed Equipment</h4>
                                {selectedJob.equipment?.length > 0 ? (
                                    <div className="space-y-3">
                                        {selectedJob.equipment.map((equip, index) => (
                                            <div key={index} className="p-3 border rounded-lg flex justify-between">
                                                <div>
                                                    <div className="font-medium">{equip.name}</div>
                                                    <div className="text-sm text-gray-600">Qty: {equip.quantity}</div>
                                                </div>
                                                <div className="text-sm text-gray-600">{equip.dateDeployed}</div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-gray-500">No equipment deployed yet</p>
                                )}
                            </div>
                        </div>
                    )}

                    {activeTab === 'documents' && (
                        <div className="space-y-6">
                            <div className="bg-gray-50 p-4 rounded-lg">
                                <h4 className="font-semibold mb-4">Upload Document for Signature</h4>
                                <p className="text-sm text-gray-600 mb-4">
                                    Upload a work order, completion certificate, or any document that needs a client signature
                                </p>
                                <input 
                                    type="file"
                                    accept="image/*,application/pdf"
                                    onChange={handleDocumentUpload}
                                    className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100 mb-4"
                                />
                                
                                {uploadedDoc && (
                                    <div className="mt-4 p-4 border rounded-lg bg-white">
                                        <div className="flex items-center justify-between mb-3">
                                            <div>
                                                <div className="font-medium">{uploadedDoc.name}</div>
                                                <div className="text-sm text-gray-500">Ready for signature</div>
                                            </div>
                                            <button
                                                onClick={handleOpenSignature}
                                                className="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg"
                                            >
                                                ‚úçÔ∏è Get Signature
                                            </button>
                                        </div>
                                        <img src={uploadedDoc.imageData} alt="Document preview" className="max-w-full h-48 object-contain" />
                                    </div>
                                )}
                            </div>

                            <div>
                                <h4 className="font-semibold mb-4">Signed Documents</h4>
                                {selectedJob.documents?.length > 0 ? (
                                    <div className="space-y-4">
                                        {selectedJob.documents.map((doc, index) => (
                                            <div key={index} className="border rounded-lg p-4 bg-white">
                                                <div className="flex items-center justify-between mb-2">
                                                    <div>
                                                        <div className="font-medium">{doc.name}</div>
                                                        <div className="text-sm text-green-600">‚úì Signed by {doc.signerName}</div>
                                                        <div className="text-xs text-gray-500">{doc.signedDate}</div>
                                                    </div>
                                                </div>
                                                <div className="mt-3">
                                                    <img src={doc.imageData} alt="Document" className="max-w-full h-32 object-contain mb-2" />
                                                    <div className="text-sm font-medium text-gray-700">Signature:</div>
                                                    <img src={doc.signatureData} alt="Signature" className="border p-2 bg-gray-50 max-w-xs" />
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                ) : (
                                    <p className="text-gray-500">No signed documents yet</p>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            </div>

            {showSignatureModal && (
                <SignatureModal
                    document={selectedDocForSigning}
                    onClose={() => setShowSignatureModal(false)}
                    onSave={handleSaveSignedDocument}
                />
            )}
        </div>
    );
}

function SignatureModal({ document, onClose, onSave }) {
    const canvasRef = React.useRef(null);
    const [isDrawing, setIsDrawing] = React.useState(false);
    const [signerName, setSignerName] = React.useState('');

    React.useEffect(() => {
        const canvas = canvasRef.current;
        if (canvas) {
            const ctx = canvas.getContext('2d');
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
        }
    }, []);

    const startDrawing = (e) => {
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const ctx = canvas.getContext('2d');
        
        setIsDrawing(true);
        const x = e.clientX ? e.clientX - rect.left : e.touches[0].clientX - rect.left;
        const y = e.clientY ? e.clientY - rect.top : e.touches[0].clientY - rect.top;
        
        ctx.beginPath();
        ctx.moveTo(x, y);
    };

    const draw = (e) => {
        if (!isDrawing) return;
        
        const canvas = canvasRef.current;
        const rect = canvas.getBoundingClientRect();
        const ctx = canvas.getContext('2d');
        
        const x = e.clientX ? e.clientX - rect.left : e.touches[0].clientX - rect.left;
        const y = e.clientY ? e.clientY - rect.top : e.touches[0].clientY - rect.top;
        
        ctx.lineTo(x, y);
        ctx.stroke();
    };

    const stopDrawing = () => {
        setIsDrawing(false);
    };

    const clearSignature = () => {
        const canvas = canvasRef.current;
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    };

    const saveSignature = () => {
        if (!signerName.trim()) {
            alert('Please enter the signer\'s name');
            return;
        }
        const canvas = canvasRef.current;
        const signatureData = canvas.toDataURL();
        onSave(signatureData, signerName);
    };

    return (
        <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
            <div className="bg-white rounded-lg shadow-xl max-w-2xl w-full p-6">
                <h3 className="text-xl font-semibold mb-4">Client Signature</h3>
                
                <div className="mb-4">
                    <label className="block text-sm font-medium mb-2">Client Name *</label>
                    <input 
                        type="text"
                        value={signerName}
                        onChange={(e) => setSignerName(e.target.value)}
                        placeholder="Enter client's full name"
                        className="w-full px-4 py-2 border rounded-lg"
                    />
                </div>

                <div className="mb-4">
                    <label className="block text-sm font-medium mb-2">Signature *</label>
                    <div className="border-2 border-gray-300 rounded-lg overflow-hidden bg-white">
                        <canvas
                            ref={canvasRef}
                            width={600}
                            height={200}
                            onMouseDown={startDrawing}
                            onMouseMove={draw}
                            onMouseUp={stopDrawing}
                            onMouseLeave={stopDrawing}
                            onTouchStart={startDrawing}
                            onTouchMove={draw}
                            onTouchEnd={stopDrawing}
                            className="w-full cursor-crosshair"
                            style={{ touchAction: 'none' }}
                        />
                    </div>
                    <p className="text-xs text-gray-500 mt-1">Sign above using your finger or mouse</p>
                </div>

                <div className="flex gap-3">
                    <button
                        onClick={clearSignature}
                        className="flex-1 bg-gray-300 hover:bg-gray-400 text-gray-700 px-4 py-2 rounded-lg"
                    >
                        Clear
                    </button>
                    <button
                        onClick={onClose}
                        className="flex-1 bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-lg"
                    >
                        Cancel
                    </button>
                    <button
                        onClick={saveSignature}
                        className="flex-1 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg"
                    >
                        Save Signature
                    </button>
                </div>
            </div>
        </div>
    );
}
